CNN 提取特征形成序列输入到 RNN 中

---
# 1 CNN
## .1 输入
因为视频相邻帧相似度太高，将所有视频帧混在一起再取出部分作为验证集，其实无法起到验证的作用。  
应该将某几个视频的所有帧拿出作为验证集


## .1 TRAIN
TODO

## .2 DEPLOY
TODO

# 2 RNN
## 输入
以 3conv 2fc 结构的 CNN 为例，分类网络训练好之后，取出倒数第2层FC的输出向量，`shape=(batch, fc_out)`  
以 `batch` 为序列长度, 给这个序列标上 label，形成 RNN 的一个训练样本 
`shape=(max_steps, fc_out)` ,   
因为一个样本体积不大(batch*fc_out), 所以将每个样本保存为 `.npy` 文件，文件名可以用对应的 `label`

输入时将多个 npy 文件组合成 batch 对RNN进行训练

**注意**
- 连续帧
  >RNN 需要的是前后相关的向量序列，也就是`CNN`的输入必须是一段视频的连续帧，而不能是训练时打乱图像组合出的batch
- 错误样本
  > 分类网络准确率不可能100%，错误样本是否要去除。另外错误样本还可能是连续帧中的某几帧
- mem 不足
  > 如果按 `batch = max_steps` 每次生成一个序列，在 max_steps 很大，同时网络很深时，大batch会导致CNN需要很大的mem，可以按 `n * batch = max_steps` 组合多个 batch




## 模型
TODO

# 3 整合
如果不要求同时训练两个网络部分，直接拼接 CNN 和 RNN 要考虑的问题就不多。
流程如下
- CNN 的输入
  > cv2 读取视频，按 RNN 需要的序列长度切割成若干块，每块 `shape = (max_steps, 3, h, w)`
- CNN 提取特征
  > 每块通过分类网络输出特征向量 `shape = (max_steps, fc_out)`, 即为一个样本
- RNN
  > 将上面的得到的样本输入 RNN ，输出预测的趋势

# 部署
分3种状态
- A 无火
  > 占大部分时间，考虑计算负载，暂定 CNN 低频采样  
  当一个batch检出火的帧数量达到某个比例`HIGH`，认定出现了火，遂进入火势分析流程，状态 B
- B 火变大
  > 缩小CNN帧采样间隔，增大batch，也就是高频采样。以batch为序列长度，使用CNN提取特征，特征输入到RNN，得到分析结果(火变大，或者变小)，及相应的可信度。  
  一段时间内，火变小次数明显多于变大时，进入状态 C
- C 火变小
  > 恢复 CNN 低频采样，降低火势分析流程的频率
  当一个batch检出火的帧数量低于某个比例`LOW`，认定火被扑灭，停止火势分析，恢复到正常状态 A

流程 | 可调参数
:-: | :-:
CNN  | `采样频率`, `batch_size`, `比例阈值 HIGH 和 LOW`
火势分析 | `序列滑动步长`


- 因为大部分时间是没有火的，所以此时间段上 CNN 大间隔帧采样，以降低负载，当一个batch检出火的帧数量达到某个比例，认定出现了火，遂进入火势分析流程
  > 可以设置的参数有 `采样间隔` `batch_size`
- 从上面确定出现火的帧开始，缩小CNN帧采样间隔，以batch为序列长度，使用CNN提取特征，特征输入到RNN，得到分析结果(火变大，或者变小)，及相应的可信度  
  火势变大停止 CNN 的大间隔帧采样，变小时开始大间隔帧采样，认定火点消失时，停止火势分析，恢复到
  > 此阶段里，计算负载会明显变大。 可以设置的参数有 `采样间隔` `batch_size`

# 4 文件说明
- cnn
  > 卷积网络定义
- dataset
  > cnn 输入 pipeline
- rnn
  > 循环神经网络定义
- rnn_dataset
  > rnn 输入 pipeline
